
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Incremental synchronization of ZIP files in bandwidth-constrained environments - Karol Stasiak's Blog</title>
  <meta name="author" content="Karol Stasiak">

  
  <meta name="description" content="Suppose you have two ZIP archives on two different machines and you want to synchronize their contents with minimal network traffic, without much &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://KarolS.github.io/blog/2015/09/13/incremental-synchronization-of-zip-files-in-bandwidth-constrained-environments">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Karol Stasiak's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-45876308-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Karol Stasiak's Blog</a></h1>
  
    <h2>Coding from an elevator.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:KarolS.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Incremental Synchronization of ZIP Files in Bandwidth-constrained Environments</h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-09-13T18:57:00+02:00" pubdate data-updated="true">2015-09-13</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Suppose you have two ZIP archives on two different machines and you want to synchronize their contents with minimal network traffic, without much regard for the CPU usage, and you know that the target machine already contains the older version of the archive, which is mostly identical to the new version. For example, you have to upload a fat JAR with the new build over a metered connection, and the server literally sits in a garage at the other end of the country.</p>

<p>If the archive is small, uploading it in its entirety looks simple enough, but if it grows into dozens of megabytes, of which 90% is non-changing 3rd party code, it quickly becomes a waste of both time and bandwidth.</p>

<p>Time is money. And depending on your ISP, bandwidth can be money too.</p>

<p>Long story short, I’m going to assume that the target machine runs Linux, and the source machine runs either Windows or Linux. I am going to use <code>rsync</code> and <code>fuse-zip</code>.</p>

<p>Why those two? Because <code>fuse-zip</code> can convert a ZIP archive into a writeable filesystem, and <code>rsync</code> can sync a writeable filesystem with another. Details below.</p>

<!-- more -->

<h3 id="task-1--mount-the-archives">Task 1 – Mount the archives</h3>

<p>Create a mountpoint on the target machine, I’ll use <code>/tmp/z</code>. Then mount your archive using <code>fuse-zip</code>:</p>

<figure class="code"><div class="highlight"><table><tr><td class="line-numbers" aria-hidden="true"><pre><div data-line="1" class="line-number"></div></pre></td><td class="main  bash"><pre><div class="line"><span class="nv">$ </span>sudo fuse-zip -o allow_other,rw,uid<span class="o">=</span><span class="sb">`</span>id -u<span class="sb">`</span>,gid<span class="o">=</span><span class="sb">`</span>id -g<span class="sb">`</span> /stuff/target.zip /tmp/z
</div></pre></td></tr></table></div></figure>

<p>To test if it works, you create a file in the mounted filesystem. It would appear in the ZIP file after you unmount it.</p>

<figure class="code"><div class="highlight"><table><tr><td class="line-numbers" aria-hidden="true"><pre><div data-line="1" class="line-number"></div><div data-line="2" class="line-number"></div><div data-line="3" class="line-number"></div></pre></td><td class="main  bash"><pre><div class="line"><span class="nv">$ </span><span class="nb">echo </span>TEST &gt; /tmp/z/TEST_FILE_PLEASE_IGNORE
</div><div class="line"><span class="nv">$ </span>sudo umount /tmp/z
</div><div class="line"><span class="nv">$ </span>unzip -l /stuff/target.zip <span class="p">|</span> grep TEST_FILE_PLEASE_IGNORE
</div></pre></td></tr></table></div></figure>

<p class="info warning" data-title="Warning">Do not modify the ZIP archive while it's being mounted and do not interrupt the unmounting process if the archive was mounted for writing, as this can corrupt it.</p>

<p>If your source machine runs Linux, you can do the same, but mount the archive read-only:</p>

<figure class="code"><div class="highlight"><table><tr><td class="line-numbers" aria-hidden="true"><pre><div data-line="1" class="line-number"></div></pre></td><td class="main  bash"><pre><div class="line"><span class="nv">$ </span>sudo fuse-zip -o allow_other,ro,uid<span class="o">=</span><span class="sb">`</span>id -u<span class="sb">`</span>,gid<span class="o">=</span><span class="sb">`</span>id -g<span class="sb">`</span> /stuff/source.zip /tmp/z
</div></pre></td></tr></table></div></figure>

<p>You should experiment a bit if <code>sudo</code> and <code>usd</code>/<code>gid</code> are necessary.</p>

<p>If your souce machine runs Windows, you can use <a href="http://www.pismotechnic.com/pfm/">Pismo File Mount</a> to mount the archive as a drive and assign it a letter. It’s a GUI program, I haven’t found a scriptable alternative yet.</p>

<h3 id="task-2--synchronize-the-mounted-filesystems">Task 2 – Synchronize the mounted filesystems</h3>

<p>On the source machine:</p>

<figure class="code"><div class="highlight"><table><tr><td class="line-numbers" aria-hidden="true"><pre><div data-line="1" class="line-number"></div></pre></td><td class="main  plain"><pre><div class="line">$ rsync --delete -zrucv -e ssh /tmp/z/ remoteuser@targethost:/tmp/z/</div></pre></td></tr></table></div></figure>

<p>Explanation for the parameters:</p>

<ul>
  <li>
    <p><code>-c</code> so that the files will be compared using checksums instead of modification dates. We do not care about nor trust  the dates here, what matters is content.</p>
  </li>
  <li>
    <p><code>-z</code> for the compression. Do not use the flag if the files themselves won’t compress well.</p>
  </li>
  <li>
    <p><code>-r</code> for recursive synchronization.</p>
  </li>
  <li>
    <p><code>-u</code> so only modified files are uploaded.</p>
  </li>
  <li>
    <p><code>--delete</code> so the files that are absent in the source archive will be deleted from the target archive. We want the target archive to have the same content as the source one, not more.</p>
  </li>
  <li>
    <p><code>-v</code> stands for verbose. Used once, makes <code>rsync</code> list all the files as they are being sent. You can skip this option, or repeat it several times, depending on your preference.</p>
  </li>
  <li>
    <p><code>-e ssh</code> picks the shell used to synchronize the files. SSH is the recommended one for most cases.</p>
  </li>
</ul>

<p>Note that the paths end with slashes, so <code>rsync</code> synchronizes the contents of the directories, not the directories themselves.</p>

<p>If the source mashine is running Windows, you can use <a href="">Cygwin</a>https://www.cygwin.com/, just install appropriate packages (you’ll need <code>rsync</code> and most likely also <code>openssh</code>). If you used Pismo File Mount to mount the ZIP to e.g. J: drive, use <code>/cygdrive/j/</code> as your source directory.</p>

<h3 id="task-3--unmount-the-filesystems">Task 3 – Unmount the filesystems</h3>

<p>On Linux (both source and target machine), do</p>

<figure class="code"><div class="highlight"><table><tr><td class="line-numbers" aria-hidden="true"><pre><div data-line="1" class="line-number"></div></pre></td><td class="main  bash"><pre><div class="line"><span class="nv">$ </span>sudo umount /tmp/z
</div></pre></td></tr></table></div></figure>

<p>You have to unmount the target archive so the changes take place, and the source archive so the next time you mount it, it would be current again.</p>

<h3 id="putting-it-all-together">Putting it all together</h3>

<p>Here is a small script that can be used to synchronize two ZIP archives:</p>

<figure class="code"><div class="highlight"><table><tr><td class="line-numbers" aria-hidden="true"><pre><div data-line="1" class="line-number"></div><div data-line="2" class="line-number"></div><div data-line="3" class="line-number"></div><div data-line="4" class="line-number"></div><div data-line="5" class="line-number"></div><div data-line="6" class="line-number"></div><div data-line="7" class="line-number"></div><div data-line="8" class="line-number"></div><div data-line="9" class="line-number"></div><div data-line="10" class="line-number"></div><div data-line="11" class="line-number"></div><div data-line="12" class="line-number"></div><div data-line="13" class="line-number"></div><div data-line="14" class="line-number"></div><div data-line="15" class="line-number"></div><div data-line="16" class="line-number"></div><div data-line="17" class="line-number"></div><div data-line="18" class="line-number"></div><div data-line="19" class="line-number"></div><div data-line="20" class="line-number"></div><div data-line="21" class="line-number"></div><div data-line="22" class="line-number"></div><div data-line="23" class="line-number"></div><div data-line="24" class="line-number"></div><div data-line="25" class="line-number"></div><div data-line="26" class="line-number"></div><div data-line="27" class="line-number"></div><div data-line="28" class="line-number"></div><div data-line="29" class="line-number"></div><div data-line="30" class="line-number"></div><div data-line="31" class="line-number"></div><div data-line="32" class="line-number"></div><div data-line="33" class="line-number"></div></pre></td><td class="main  bash"><pre><div class="line"><span class="c">#!/bin/bash</span>
</div><div class="line"> </div><div class="line"><span class="c"># put all the necessary values here</span>
</div><div class="line"><span class="nv">REMOTEUSER</span><span class="o">=</span>...
</div><div class="line"><span class="nv">REMOTEHOST</span><span class="o">=</span>...
</div><div class="line"><span class="nv">SOURCEZIP</span><span class="o">=</span>...
</div><div class="line"><span class="nv">TARGETZIP</span><span class="o">=</span>...
</div><div class="line"> </div><div class="line"><span class="nv">OS</span><span class="o">=</span><span class="sb">`</span>uname -o<span class="sb">`</span>
</div><div class="line"><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$OS&quot;</span> <span class="o">=</span> Cygwin <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
</div><div class="line">	<span class="c"># depends on where you mount it; assuming here the J: drive</span>
</div><div class="line">	<span class="nv">P</span><span class="o">=</span>/cygdrive/j
</div><div class="line"><span class="k">else</span>
</div><div class="line"><span class="k">	</span><span class="nv">P</span><span class="o">=</span>/tmp/z
</div><div class="line">	mkdir -p <span class="s2">&quot;$P&quot;</span>
</div><div class="line">	sudo umount <span class="s2">&quot;$P&quot;</span>
</div><div class="line">	sudo fuse-zip -o allow_other,uid<span class="o">=</span><span class="sb">`</span>id -u<span class="sb">`</span>,gid<span class="o">=</span><span class="sb">`</span>id -g<span class="sb">`</span>,ro <span class="s2">&quot;$SOURCEZIP&quot;</span> <span class="s2">&quot;$P&quot;</span>
</div><div class="line"><span class="k">fi</span>
</div><div class="line"> </div><div class="line">ssh <span class="nv">$REMOTEUSER</span>@<span class="nv">$REMOTEHOST</span> sudo jar_mount_rw
</div><div class="line">rsync --delete -zrucv -e <span class="s2">&quot;ssh&quot;</span> <span class="s2">&quot;$P/&quot;</span> <span class="nv">$REMOTEUSER</span>@<span class="nv">$REMOTEHOST</span>:/tmp/z/
</div><div class="line">ssh <span class="nv">$REMOTEUSER</span>@<span class="nv">$REMOTEHOST</span> sudo umount /tmp/z
</div><div class="line"> </div><div class="line"><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$OS&quot;</span> <span class="o">=</span> Cygwin <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
</div><div class="line"><span class="k">	</span><span class="nb">echo</span> <span class="s1">&#39;Finished. Unmount the J: drive.&#39;</span>
</div><div class="line"><span class="k">else</span>
</div><div class="line"><span class="k">	</span><span class="nv">PID</span><span class="o">=</span><span class="s2">&quot;`pgrep fuse-zip`&quot;</span>
</div><div class="line">	<span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$PID&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
</div><div class="line"><span class="k">		</span><span class="nb">exit</span>
</div><div class="line"><span class="nb">	</span><span class="k">else</span>
</div><div class="line"><span class="k">		</span>sudo umount <span class="s2">&quot;$P&quot;</span>
</div><div class="line">	<span class="k">fi</span>
</div><div class="line"><span class="k">fi</span>
</div></pre></td></tr></table></div></figure>

<p>It requires this script to be present as <code>jar_mount_rw</code> on the target machine:</p>

<figure class="code"><figcaption>jar_mount_rw</figcaption><div class="highlight"><table><tr><td class="line-numbers" aria-hidden="true"><pre><div data-line="1" class="line-number"></div><div data-line="2" class="line-number"></div><div data-line="3" class="line-number"></div><div data-line="4" class="line-number"></div><div data-line="5" class="line-number"></div><div data-line="6" class="line-number"></div><div data-line="7" class="line-number"></div><div data-line="8" class="line-number"></div></pre></td><td class="main  bash"><pre><div class="line"><span class="c">#!/bin/bash</span>
</div><div class="line"> </div><div class="line"><span class="c"># put all the necessary values here</span>
</div><div class="line"><span class="nv">TARGETZIP</span><span class="o">=</span>...
</div><div class="line"> </div><div class="line">umount /tmp/z
</div><div class="line">mkdir -p /tmp/z
</div><div class="line">fuse-zip -o allow_other,rw,uid<span class="o">=</span><span class="sb">`</span>id -u<span class="sb">`</span>,gid<span class="o">=</span><span class="sb">`</span>id -g<span class="sb">`</span> <span class="s2">&quot;$TARGETZIP&quot;</span> /tmp/z
</div></pre></td></tr></table></div></figure>

<h3 id="results">Results</h3>

<p>I don’t have any hard data, but the overall effect is that a 40 MB JAR archive with only few files modified in it gets synchronized in few seconds, while it could take several minutes on slower connections to upload it whole.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Karol Stasiak</span></span>

      








  


<time datetime="2015-09-13T18:57:00+02:00" pubdate data-updated="true">2015-09-13</time>
      

<span class="categories">
  
    <a class='category' href='/categories/command-line/'>command line</a>, <a class='category' href='/categories/deployment/'>deployment</a>, <a class='category' href='/categories/linux/'>linux</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://KarolS.github.io/blog/2015/09/13/incremental-synchronization-of-zip-files-in-bandwidth-constrained-environments/" data-via="" data-counturl="http://KarolS.github.io/blog/2015/09/13/incremental-synchronization-of-zip-files-in-bandwidth-constrained-environments/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2015/08/08/java-8-functional-interfaces-cheatsheet/" title="Previous Post: Java 8 Functional Interfaces Cheatsheet">&laquo; Java 8 Functional Interfaces Cheatsheet</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/09/13/incremental-synchronization-of-zip-files-in-bandwidth-constrained-environments/">Incremental Synchronization of ZIP Files in Bandwidth-constrained Environments</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/08/08/java-8-functional-interfaces-cheatsheet/">Java 8 Functional Interfaces Cheatsheet</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/29/random-ideas-for-scala-3-0/">Random Ideas for Scala 3.0</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/29/implementing-catamorphisms-in-java/">Implementing Catamorphisms in Java</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/29/from-nested-monads-to-kleisli-arrows-over-monad-transformers/">From Explicit Nested Monads to Kleisli Arrows Over Monad Transformers</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Category Cloud</h1>
    <span id="tag-cloud"><a href='/categories/command-line' style='font-size: 110.0%'>command line(1)</a> <a href='/categories/deployment' style='font-size: 110.0%'>deployment(1)</a> <a href='/categories/haskell' style='font-size: 110.0%'>haskell(1)</a> <a href='/categories/hocr4j' style='font-size: 110.0%'>hocr4j(1)</a> <a href='/categories/java' style='font-size: 130.0%'>java(3)</a> <a href='/categories/keyboard' style='font-size: 110.0%'>keyboard(1)</a> <a href='/categories/linux' style='font-size: 120.0%'>linux(2)</a> <a href='/categories/maths' style='font-size: 110.0%'>maths(1)</a> <a href='/categories/ocr' style='font-size: 110.0%'>ocr(1)</a> <a href='/categories/personal-project' style='font-size: 120.0%'>personal project(2)</a> <a href='/categories/programming' style='font-size: 160.0%'>programming(6)</a> <a href='/categories/scala' style='font-size: 120.0%'>scala(2)</a> <a href='/categories/unicode' style='font-size: 110.0%'>unicode(1)</a> <a href='/categories/units' style='font-size: 110.0%'>units(1)</a> <a href='/categories/units-of-measurement' style='font-size: 110.0%'>units of measurement(1)</a> </span>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Karol Stasiak -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'codingfromanelevator';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://KarolS.github.io/blog/2015/09/13/incremental-synchronization-of-zip-files-in-bandwidth-constrained-environments/';
        var disqus_url = 'http://KarolS.github.io/blog/2015/09/13/incremental-synchronization-of-zip-files-in-bandwidth-constrained-environments/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
